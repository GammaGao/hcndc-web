# 网状分布式调度平台——执行端
[HCNDC-exec](http://172.16.163.4:8888/xuexiang/HCNDC-exec)

# 需求文档链接
[需求文档链接](./README.md)

# 一、相关配置
## 1.测试环境
URL: http://172.16.163.8:2333/index/
用户名: admin
密码: admin

## 2.项目启动配置
* 分别修改web端和exec端配置文件superconf.json中mysql配置
* mysql新建一个数据库(建议: hcndc)
* 在mysql新建库中执行web项目下`调度平台数据库ddl.txt`文件
* 安装python依赖模块
```
# web端依赖
cd hcndc-web
pip install -r requirements.txt -i http://172.16.218.11:8081/repository/pypi-proxy/simple --trusted-host 172.16.218.11
# exec端依赖
cd hcndc-exec
pip install -r requirements.txt -i http://172.16.218.11:8081/repository/pypi-proxy/simple --trusted-host 172.16.218.11
```
* 分别启动web端和exec端
```
# 启动web端
cd hcndc-web
nohup python3 server.py &
# 启动exec端
cd hcndc-exec
nohup python3 server.py &
```
* 查看是否启动成功
一共3个进程, 2个主进程, 1个子进程
```
[root@test-bgd-cdh-04 ~]# ps -ef | grep python3
root     10976 10954  0 10:17 pts/5    00:00:00 grep --color=auto python3
root     32022     1  0 Sep26 ?        00:00:07 python3 server.py
root     32086     1  0 Sep26 ?        00:00:00 python3 server.py
root     32090 32086  0 Sep26 ?        00:07:53 /usr/bin/python3 /root/hcdnc/hcndc-exec/server.py
```

# 二、配置执行服务器

## 1.说明描述
* hcndc-web  ---- web服务(master服务)
* hcndc-exec ---- exec服务(执行服务)
* web服务管理所有的exec执行服务, 所有的任务调度和执行都会分发到执行服务进行
* web所在master服务器能够ping通所有部署exec执行服务器
* 在需要执行任务的服务器上部署exec服务
## 2.项目配置
* 在执行服务器上部署并启动`hcndc-exec`服务, 默认端口`7890`, 请确保该端口未被占用
* 如需更改端口,  请确保hcndc-web服务和hcndc-exec服务superconf.json文件配置中exec.port端口一致, 并**重启所有机器上的hcndc-web和hcndc-exec服务**
## 3.web页面配置
`基础配置-执行服务器列表`

![](/x_other/新增执行服务器.png)

新增服务器IP(也可填写服务器域名, 确保web所在服务器有域名映射即可)和自定义服务器名称

# 三、配置任务流
## 1.说明描述
* 任务流模块相当于一般调度系统中的任务流概念, 用于把多个任务串联在一起, 实现各个任务之间的依赖关系
* 任务流列表可以查看该任务流下的任务依赖关系

![](/x_other/任务依赖.png)
## 2.web配置
`任务总览-任务流列表`

![](/x_other/新增任务流.png)

# 四、配置任务
## 1.说明描述
* 任务配置需要选择其所属任务流
* 一个任务只能属于一个任务流
* 不同任务流之间的任务可以互相依赖
* 任务执行方式为命令行执行
* 环境变量为启动该服务的用户所属的环境变量
* 依赖任务为执行该任务前的前置任务, 可以多选
* 任务列表可以手动单独触发, 不用考虑前置任务是否完成
## 2.web配置
`任务总览-任务列表`
![](/x_other/新增任务.png)

## 3.批量导入
目前只支持csv, xlsx, xls三种格式
### 模板路径
`/hcndc-web/uploads`

![](/x_other/批量导入.png)

* 序号:                                          用户自定义, 用于标识不同任务.(不可重复, 参数必须为整型)
* 所属任务流id:                               调度系统中已有任务流id.(参数必须为整型, 该任务流id必须存在)
* 任务名称:                                  用户自定义.(非空, 参数必须为字符串类型)
* 任务描述:                                  用户自定义.(参数必须为字符串类型)
* 服务器id:                                  调度系统中已有服务器id.(参数必须为整型, 该服务器id必须存在)
* 脚本目录:                                  用户自定义.(参数必须为字符串类型)
* 脚本命令:                                  用户自定义.(非空, 参数必须为字符串类型)
* 依赖任务序号(本次新建任务): 在本次新建任务中, 该任务所依赖的任务序号.(参数必须为整型, 多个依赖任务时按逗号分隔, 该序号必须存在)
* 依赖任务id(已有任务):             在已有的任务中, 该任务所依赖的任务id.(参数必须为整型, 多个依赖任务时按逗号分隔, 该id必须存在)
* 任务参数:                                  在已有的任务参数中, 该任务所选的任务任务参数.(参数必须为整型, 多个依赖任务时按逗号分隔, 该id必须存在)
### 前端入口
![](/x_other/批量导入入口.png)

# 五、数据源配置
## 1.说明描述
数据源配置作为任务参数配置的前置功能, 任务参数分为`静态参数`和`SQL参数`, 其中`SQL参数`使用sql查询数据库中的字段, 数据库配置在`数据源配置`功能中完成. 本系统提供4中数据库.
* mysql
* msql
* hive
* impala

## 2.web配置
`任务总览-数据源配置`
![](/x_other/数据源配置.png)

# 六、参数配置
## 1.说明描述
参数配置用来配置全局变量, 为任务配置中`任务参数`字段使用, 参数配置分为两种, 静态参数和SQL参数.

## 2.web配置
`任务总览-参数配置`
![](/x_other/参数配置.png)

# 七、配置调度
## 1.说明描述
* 调度系统是基于任务流进行定时任务触发的
* 目前只支持cron表达式触发
* 调度列表可以进行立即执行、恢复、暂停调度等功能
* 一个任务流只能配置一个调度任务, 不能重复配置
## 2.web配置
`调度总览-调度列表`

![](/x_other/新增调度.png)

# 八、运行日志
`调度总览-任务流日志`
* 可以查看每一次执行任务日志, 包括手动执行和调度执行
* 执行详情中有网络拓扑、任务列表、运行日志等功能

![](/x_other/任务流日志.png)
